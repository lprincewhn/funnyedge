<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>根据客户端所在国家选择源站 :: Funny Edge Workshop</title><link href=/css/nucleus.css?1653005512 rel=stylesheet><link href=/css/fontawesome-all.min.css?1653005512 rel=stylesheet><link href=/css/hybrid.css?1653005512 rel=stylesheet><link href=/css/featherlight.min.css?1653005512 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1653005512 rel=stylesheet><link href=/css/auto-complete.css?1653005512 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1653005512 rel=stylesheet><link href=/css/theme.css?1653005512 rel=stylesheet><link href=/css/tabs.css?1653005512 rel=stylesheet><link href=/css/hugo-theme.css?1653005512 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1653005512></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/60_customized/10_multi_origin/><nav id=sidebar><div id=header-wrapper><div id=header><img src=/images/logo.png width=60%></div></div><section id=homelinks><ul><li><a class=padding href=/><i class="fas fa-home"></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/10_quickstart/ title=快速部署 class=dd-item><a href=/10_quickstart/><b>1. </b>快速部署</a><ul><li data-nav-id=/10_quickstart/10_console/ title=CloudFront控制台介绍 class=dd-item><a href=/10_quickstart/10_console/>CloudFront控制台介绍</a></li><li data-nav-id=/10_quickstart/20_certificate/ title=证书管理(可选) class=dd-item><a href=/10_quickstart/20_certificate/>证书管理(可选)</a></li><li data-nav-id=/10_quickstart/30_static/ title=静态内容加速 class=dd-item><a href=/10_quickstart/30_static/>静态内容加速</a></li><li data-nav-id=/10_quickstart/40_dynamic/ title=动态接口加速 class=dd-item><a href=/10_quickstart/40_dynamic/>动态接口加速</a></li><li data-nav-id=/10_quickstart/50_website/ title=网站加速 class=dd-item><a href=/10_quickstart/50_website/>网站加速</a></li></ul></li><li data-nav-id=/20_monitor/ title=监控分析 class=dd-item><a href=/20_monitor/><b>2. </b>监控分析</a><ul><li data-nav-id=/20_monitor/10_aws_metrics/ title=CloudFront指标 class=dd-item><a href=/20_monitor/10_aws_metrics/>CloudFront指标</a></li><li data-nav-id=/20_monitor/10_cloudwatch/ title=在CloudWatch查看指标 class=dd-item><a href=/20_monitor/10_cloudwatch/>在CloudWatch查看指标</a></li><li data-nav-id=/20_monitor/20_customeized_metrics/ title=自定义指标 class=dd-item><a href=/20_monitor/20_customeized_metrics/>自定义指标</a></li><li data-nav-id=/20_monitor/30_access_log/ title=使用Athena分析访问日志 class=dd-item><a href=/20_monitor/30_access_log/>使用Athena分析访问日志</a></li></ul></li><li data-nav-id=/30_operations/ title=运维管理 class=dd-item><a href=/30_operations/><b>3. </b>运维管理</a><ul><li data-nav-id=/30_operations/10_tag/ title=利用标签进行权限限制和费用分摊 class=dd-item><a href=/30_operations/10_tag/>利用标签进行权限限制和费用分摊</a></li><li data-nav-id=/30_operations/20_certificate_expire/ title=证书过期提醒 class=dd-item><a href=/30_operations/20_certificate_expire/>证书过期提醒</a></li></ul></li><li data-nav-id=/40_tunning/ title=性能提升 class=dd-item><a href=/40_tunning/><b>4. </b>性能提升</a><ul><li data-nav-id=/40_tunning/10_originshield/ title=源护盾 class=dd-item><a href=/40_tunning/10_originshield/>源护盾</a></li></ul></li><li data-nav-id=/50_troubleshoot/ title=故障排查 class=dd-item><a href=/50_troubleshoot/><b>5. </b>故障排查</a><ul><li data-nav-id=/50_troubleshoot/10_dns_check/ title=检查域名解析情况 class=dd-item><a href=/50_troubleshoot/10_dns_check/>检查域名解析情况</a></li><li data-nav-id=/50_troubleshoot/20_openssl/ title=检查SSL连接 class=dd-item><a href=/50_troubleshoot/20_openssl/>检查SSL连接</a></li><li data-nav-id=/50_troubleshoot/30_curl/ title=检查HTTP连接 class=dd-item><a href=/50_troubleshoot/30_curl/>检查HTTP连接</a></li></ul></li><li data-nav-id=/60_customized/ title=边缘计算 class="dd-item
parent"><a href=/60_customized/><b>6. </b>边缘计算</a><ul><li data-nav-id=/60_customized/10_multi_origin/ title=根据客户端所在国家选择源站 class="dd-item active"><a href=/60_customized/10_multi_origin/>根据客户端所在国家选择源站</a></li></ul></li></ul><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/>有趣的CDN</a> > <a href=/60_customized/>边缘计算</a> > 根据客户端所在国家选择源站</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#0-打开cloudshell>0. 打开CloudShell</a></li><li><a href=#1-创建lambdaedge函数>1. 创建Lambda@Edge函数</a></li><li><a href=#2-关联lambdaedge函数>2. 关联Lambda@Edge函数</a></li><li><a href=#3-设置回源标头>3. 设置回源标头</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>根据客户端所在国家选择源站</h1><h3 id=0-打开cloudshell>0. 打开CloudShell</h3><p><a href=https://console.aws.amazon.com/cloudshell/home>https://console.aws.amazon.com/cloudshell/home</a></p><p>CloudShell在浏览器上提供了一个运行各种aws命令行工具的的shell环境，使得你可以非常简单的使用命令管理和操作AWS资源。CloudShell直接继承登陆控制台用户的权限，无需额外使用AKSK，从而避免了AKSK泄露的风险。</p><p><img src="/images/cloudshell.png?classes=border" alt=CloudShell></p><p><strong>小技巧：在控制台右上角的“操作”菜单,通过上传和下载文件可进行本地和CloudShell之间的文件传输。</strong></p><h3 id=1-创建lambdaedge函数>1. 创建Lambda@Edge函数</h3><p>1.1 创建策略</p><pre><code># 定义角色信任策略文档：该策略将用于创建一个角色，并且允许Lambda及Lambda@Edge切换至该角色
cat &lt;&lt;EoF &gt; lambdaedge-assume-role-policy.json
{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Principal&quot;: {
                &quot;Service&quot;: [
                    &quot;edgelambda.amazonaws.com&quot;,
                    &quot;lambda.amazonaws.com&quot;
                ]
            },
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;
        }
    ]
}
EoF

# 创建角色并将其ARN保存在环境变量
ROLE_NAME=lambda-edge-multi-origin-role
ROLE_ARN=$(aws iam create-role --role-name $ROLE_NAME --assume-role-policy-document file://lambdaedge-assume-role-policy.json --query Role.Arn --no-cli-pager --output text)
echo $ROLE_ARN

# 定义权限策略文档：该策略将允许上述角色往所有区域的cloudwatch写入日志
cat &lt;&lt;EoF &gt; lambdaedge-write-cloudwatch-log-policy.json
{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;logs:CreateLogGroup&quot;,
                &quot;logs:CreateLogStream&quot;,
                &quot;logs:PutLogEvents&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:logs:*:*:*&quot;
            ]
        }
    ]
}
EoF

# 创建策略并将其ARN保存在环境变量
POLICY_ARN=$(aws iam create-policy --policy-name LambdaEdgeWriteCloudWatchLogPolicy --policy-document  file://lambdaedge-write-cloudwatch-log-policy.json --query Policy.Arn --no-cli-pager --output text)
echo $POLICY_ARN

# 附加所需权限
aws iam attach-role-policy --role-name $ROLE_NAME --policy-arn $POLICY_ARN
</code></pre><p>1.2 创建Lambda函数及版本</p><p>函数：<a href=/multi-origin.zip>multi-origin.zip</a></p><pre><code># 创建函数
wget http://localhost:1313/multi-origin.zip
FUNCTION_NAME=edge-multi-origin
aws lambda create-function --function-name $FUNCTION_NAME --runtime 'python3.7' --role $ROLE_ARN --handler lambda_function.lambda_handler --zip-file fileb://multi-origin.zip --no-cli-pager --region us-east-1

# 发布版本 
LAMBDA_EDGE_ARN=$(aws lambda publish-version --function-name $FUNCTION_NAME --no-cli-pager --output text --query 'FunctionArn' --region us-east-1)
echo $LAMBDA_EDGE_ARN
</code></pre><h3 id=2-关联lambdaedge函数>2. 关联Lambda@Edge函数</h3><p>2.1 点击CloudFront分配ID进入详情页。
<img src="/images/modify_distribution.png?classes=border" alt=修改分配></p><p>2.2 切换到”缓存行为“标签页，选择需要修改的行为，点击”编辑“按钮
<img src="/images/modify_behaviour.png?classes=border" alt=修改行为></p><p>2.3 在行为详情页的底部“函数关联“，将之前创建的Lambda@Edge关联到源请求事件上
<img src="/images/assocaite_lambda_edge.png?classes=border" alt=函数关联></p><h3 id=3-设置回源标头>3. 设置回源标头</h3><p>3.1 点击CloudFront分配ID进入详情页。
<img src="/images/modify_distribution.png?classes=border" alt=修改分配></p><p>3.2 切换到”源“标签页，选择需要修改的源，点击”编辑“按钮
<img src="/images/modify_origin.png?classes=border" alt=修改源></p><p>3.3 在“添加自定义标头“部分，根据需求添加以下标头
<img src="/images/add_origin_header.png?classes=border" alt=添加自定义标头></p><p>这些标头将作为Lambda@Edge函数的入参控制其行为，参数说明如下：</p><ul><li>lambda-debug，控制日志输出，只要存在该标头，则函数输出更详细的Debug日志</li><li>countries-list, 国家组，以国家ISO二位编码表示，相同源站的国家为一组，组之间以逗号分隔，组内国家之间以竖线分隔</li><li>origin-list，源站列表，数量需要和国家组一样，位置上一一对应</li></ul><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/60_customized/ title=边缘计算><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/10_quickstart/ title=快速部署 style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1653005512></script><script src=/js/perfect-scrollbar.min.js?1653005512></script><script src=/js/perfect-scrollbar.jquery.min.js?1653005512></script><script src=/js/jquery.sticky.js?1653005512></script><script src=/js/featherlight.min.js?1653005512></script><script src=/js/highlight.pack.js?1653005512></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1653005512></script><script src=/js/learn.js?1653005512></script><script src=/js/hugo-learn.js?1653005512></script><script src=/mermaid/mermaid.js?1653005512></script><script>mermaid.initialize({startOnLoad:!0})</script></body></html>